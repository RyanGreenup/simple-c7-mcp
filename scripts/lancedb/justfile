package_name := `python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])"`

# Show available commands
default:
    @just --list

# Run the CLI without installing
run *args:
    uv run lance-db-example {{ args }}

lint:
    ruff check
    uv run -- pyright .
    uv run -- basedpyright .

format:
    ruff check --fix
    ruff format

test:
    uv run pytest -v .



# Install the CLI tool globally
install:
    uv tool install . --force

# Uninstall the CLI tool
uninstall:
    uv tool uninstall {{ package_name }}

# Reinstall the CLI tool
reinstall:
    uv tool install . --force --reinstall

# LanceDB specific commands

# Ingest the sample document
ingest-sample:
    uv run lance-db-example ingest sample_document.txt

# Ingest a custom file
ingest file:
    uv run lance-db-example ingest {{file}}

# Search for a query
search query:
    uv run lance-db-example search "{{query}}"

# Search with limit
search-limit query limit="10":
    uv run lance-db-example search "{{query}}" --limit {{limit}}

# List all tables in the database
list-tables:
    uv run lance-db-example list-tables

# Show statistics for a table
stats:
    uv run lance-db-example stats

# Complete demo workflow
demo:
    @echo "üöÄ Running complete demo..."
    @echo ""
    @echo "Step 1: Ingesting sample document"
    just ingest-sample
    @echo ""
    @echo "Step 2: Searching for 'neural networks'"
    just search "neural networks"
    @echo ""
    @echo "Step 3: Searching for 'supervised learning'"
    just search "supervised learning"
    @echo ""
    @echo "Step 4: Searching for 'healthcare applications'"
    just search "healthcare applications"
    @echo ""
    @echo "Step 5: Listing tables"
    just list-tables
    @echo ""
    @echo "Step 6: Showing statistics"
    just stats
    @echo ""
    @echo "‚úÖ Demo complete!"

# Clean the database
clean-db:
    rm -rf lancedb_data
    @echo "‚úÖ Database cleaned"

# Show CLI help
help:
    uv run lance-db-example --help

# Open a DuckDB SQL shell with Lance data loaded
shell db_path="./lancedb_data" table="documents":
    #!/usr/bin/env python3
    import sys
    import subprocess
    from pathlib import Path

    db_path = "{{ db_path }}"
    table = "{{ table }}"

    if not Path(db_path).exists():
        print(f"‚ö†Ô∏è  Database not found at: {db_path}")
        print("Run 'just ingest-sample' first to create a database")
        sys.exit(1)

    print("ü¶Ü Opening DuckDB SQL shell with Lance data...")
    print(f"üìä Database: {db_path}")
    print(f"üìã Table: {table}")
    print()
    print("Example queries:")
    print("  SELECT COUNT(*) FROM docs;")
    print("  SELECT text, chunk_index FROM docs LIMIT 5;")
    print("  SELECT * FROM docs WHERE chunk_index < 3;")
    print("  .schema docs")
    print()

    # Open DuckDB with init commands using process substitution (no temp file)
    view_path = f"{db_path}/{table}.lance"

    # Build init commands as separate lines to avoid justfile parsing issues
    commands = []
    commands.append("INSTALL lance FROM community;")
    commands.append("LOAD lance;")
    commands.append(f"CREATE OR REPLACE VIEW docs AS SELECT * FROM __lance_scan('{view_path}');")
    commands.append(".timer on")
    commands.append("SELECT 'üéØ Connected! Table \"docs\" has ' || COUNT(*)::VARCHAR || ' rows' as status FROM docs;")
    init_script = "\n".join(commands)

    # Build the bash command with heredoc
    bash_cmd = f"duckdb -init <(cat <<'INITEOF'\n{init_script}\nINITEOF\n)"

    subprocess.run(['bash', '-c', bash_cmd])

# Fetch library docs from Context7 and ingest into LanceDB
fetch-library library query="":
    #!/usr/bin/env python3
    import json
    import sys
    import os
    import subprocess
    from pathlib import Path
    import urllib.request

    library = "{{ library }}"
    query = "{{ query }}" or f"Documentation for {library}"

    print(f"üîç Resolving library: {library}")

    # Step 1: Call Context7 MCP API directly with proper JSON parsing
    mcp_url = "https://mcp.context7.com/mcp"

    # Get API key from environment if available
    api_key = os.environ.get('CONTEXT7_API_KEY', '')

    # Construct MCP request
    request_data = {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "tools/call",
        "params": {
            "name": "resolve-library-id",
            "arguments": {
                "libraryName": library,
                "query": query
            }
        }
    }

    # Make the API request
    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json, text/event-stream'
    }
    if api_key:
        headers['CONTEXT7_API_KEY'] = api_key

    req = urllib.request.Request(
        mcp_url,
        data=json.dumps(request_data).encode('utf-8'),
        headers=headers
    )

    try:
        with urllib.request.urlopen(req) as response:
            result = json.loads(response.read().decode('utf-8'))
    except Exception as e:
        print(f"‚ùå API request failed: {e}")
        sys.exit(1)

    # Parse the JSON response properly
    try:
        # Extract the text content from the MCP response
        content_text = result['result']['content'][0]['text']

        # Parse all library options from the text
        libraries = []
        current_lib = {}

        for line in content_text.split('\n'):
            line = line.strip()

            if line.startswith('- Title:'):
                # Save previous library if exists
                if current_lib.get('id'):
                    libraries.append(current_lib)
                current_lib = {'title': line.split('- Title:')[1].strip()}

            elif line.startswith('- Context7-compatible library ID:'):
                current_lib['id'] = line.split('Context7-compatible library ID:')[1].strip()

            elif line.startswith('- Description:'):
                current_lib['description'] = line.split('- Description:')[1].strip()

            elif line.startswith('- Benchmark Score:'):
                try:
                    current_lib['score'] = float(line.split('- Benchmark Score:')[1].strip())
                except:
                    current_lib['score'] = 0

        # Save the last library
        if current_lib.get('id'):
            libraries.append(current_lib)

        if not libraries:
            print("‚ùå No libraries found in response")
            print("\nAPI Response:")
            print(json.dumps(result, indent=2))
            sys.exit(1)

        # Sort by benchmark score (highest first)
        libraries.sort(key=lambda x: x.get('score', 0), reverse=True)

        # Pick the best match (highest score)
        best_match = libraries[0]
        library_id = best_match['id']

        print(f"‚úì Selected: {best_match['title']} (score: {best_match.get('score', 'N/A')})")
        if len(libraries) > 1:
            print(f"  (Found {len(libraries)} options, selected highest score)")

    except (KeyError, IndexError, TypeError) as e:
        print(f"‚ùå Failed to parse API response: {e}")
        print("\nRaw response:")
        print(json.dumps(result, indent=2))
        sys.exit(1)

    print(f"‚úì Resolved library_id: {library_id}")

    # Step 2: Construct URL and download docs
    # library_id format: /websites/daisyui or /github/org/repo
    url = f"https://context7.com{library_id}/llms.txt"
    print(f"üì• Downloading from: {url}")

    try:
        with urllib.request.urlopen(url) as response:
            content = response.read().decode('utf-8')
    except Exception as e:
        print(f"‚ùå Failed to download: {e}")
        sys.exit(1)

    # Step 3: Save to tests/data/{library}.md
    safe_name = library.lower().replace(' ', '-').replace('.', '-')
    output_file = Path(f"tests/data/{safe_name}.md")
    output_file.parent.mkdir(parents=True, exist_ok=True)

    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(content)

    print(f"‚úì Saved to: {output_file}")
    print(f"üìä Size: {len(content)} bytes")

    # Step 4: Ingest into LanceDB
    print(f"\nüìö Ingesting into LanceDB...")
    subprocess.run([
        'uv', 'run', 'lance-db-example', 'ingest',
        str(output_file),
        '--library', safe_name
    ])

    print(f"\n‚úÖ Complete! Library '{library}' is now in LanceDB")
    print(f"Try: just search '{library}' --limit 5")

# Demo: Ingest solid.md and search for "throw redirect" (uses markdown-h3 by default)
demo-solid:
    @echo "üìö Ingesting solid.md with markdown h3 chunking..."
    uv run lance-db-example ingest tests/data/solid.md --library solid-js
    @echo ""
    @echo "üîç Searching for 'throw redirect'..."
    uv run lance-db-example search "throw redirect" --limit 3
    @echo ""
    @echo "‚úÖ Demo complete! Check the chunking above."

# Demo: Ingest with character-based chunking (old behavior)
demo-solid-char:
    @echo "üìö Ingesting solid.md with character-based chunking..."
    uv run lance-db-example ingest tests/data/solid.md --chunking-strategy character --chunk-size 1000
    @echo ""
    @echo "üîç Searching for 'throw redirect'..."
    uv run lance-db-example search "throw redirect" --limit 3
    @echo ""
    @echo "‚úÖ Demo complete!"

# Demo: Fetch and ingest daisyUI documentation
demo-daisyui:
    just fetch-library "daisyUI"
    @echo ""
    @echo "üîç Searching daisyUI docs..."
    uv run lance-db-example search "button component" --limit 3
