package_name := `python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['name'])"`

# Show available commands
default:
    @just --list

# Run the CLI without installing
run *args:
    uv run lance-db-example {{ args }}

lint:
    ruff check
    uv run -- pyright .
    uv run -- basedpyright .

format:
    ruff check --fix
    ruff format

test:
    uv run pytest -v .



# Install the CLI tool globally
install:
    uv tool install . --force

# Uninstall the CLI tool
uninstall:
    uv tool uninstall {{ package_name }}

# Reinstall the CLI tool
reinstall:
    uv tool install . --force --reinstall

# LanceDB specific commands

# Ingest the sample document
ingest-sample:
    uv run lance-db-example ingest sample_document.txt

# Ingest a custom file
ingest file:
    uv run lance-db-example ingest {{file}}

# Search for a query
search query:
    uv run lance-db-example search "{{query}}"

# Search with limit
search-limit query limit="10":
    uv run lance-db-example search "{{query}}" --limit {{limit}}

# List all tables in the database
list-tables:
    uv run lance-db-example list-tables

# Show statistics for a table
stats:
    uv run lance-db-example stats

# Complete demo workflow
demo:
    @echo "üöÄ Running complete demo..."
    @echo ""
    @echo "Step 1: Ingesting sample document"
    just ingest-sample
    @echo ""
    @echo "Step 2: Searching for 'neural networks'"
    just search "neural networks"
    @echo ""
    @echo "Step 3: Searching for 'supervised learning'"
    just search "supervised learning"
    @echo ""
    @echo "Step 4: Searching for 'healthcare applications'"
    just search "healthcare applications"
    @echo ""
    @echo "Step 5: Listing tables"
    just list-tables
    @echo ""
    @echo "Step 6: Showing statistics"
    just stats
    @echo ""
    @echo "‚úÖ Demo complete!"

# Clean the database
clean-db:
    rm -rf lancedb_data
    @echo "‚úÖ Database cleaned"

# Show CLI help
help:
    uv run lance-db-example --help

# Open a DuckDB SQL shell with Lance data loaded
shell db_path="./lancedb_data" table="documents":
    #!/usr/bin/env python3
    import sys
    import subprocess
    from pathlib import Path

    db_path = "{{ db_path }}"
    table = "{{ table }}"

    if not Path(db_path).exists():
        print(f"‚ö†Ô∏è  Database not found at: {db_path}")
        print("Run 'just ingest-sample' first to create a database")
        sys.exit(1)

    print("ü¶Ü Opening DuckDB SQL shell with Lance data...")
    print(f"üìä Database: {db_path}")
    print(f"üìã Table: {table}")
    print()
    print("Example queries:")
    print("  SELECT COUNT(*) FROM docs;")
    print("  SELECT text, chunk_index FROM docs LIMIT 5;")
    print("  SELECT * FROM docs WHERE chunk_index < 3;")
    print("  .schema docs")
    print()

    # Open DuckDB with init commands using process substitution (no temp file)
    view_path = f"{db_path}/{table}.lance"

    # Build init commands as separate lines to avoid justfile parsing issues
    commands = []
    commands.append("INSTALL lance FROM community;")
    commands.append("LOAD lance;")
    commands.append(f"CREATE OR REPLACE VIEW docs AS SELECT * FROM __lance_scan('{view_path}');")
    commands.append(".timer on")
    commands.append("SELECT 'üéØ Connected! Table \"docs\" has ' || COUNT(*)::VARCHAR || ' rows' as status FROM docs;")
    init_script = "\n".join(commands)

    # Build the bash command with heredoc
    bash_cmd = f"duckdb -init <(cat <<'INITEOF'\n{init_script}\nINITEOF\n)"

    subprocess.run(['bash', '-c', bash_cmd])

# Demo: Ingest solid.md and search for "throw redirect" (uses markdown-h3 by default)
demo-solid:
    @echo "üìö Ingesting solid.md with markdown h3 chunking..."
    uv run lance-db-example ingest tests/data/solid.md --library solid-js
    @echo ""
    @echo "üîç Searching for 'throw redirect'..."
    uv run lance-db-example search "throw redirect" --limit 3
    @echo ""
    @echo "‚úÖ Demo complete! Check the chunking above."

# Demo: Ingest with character-based chunking (old behavior)
demo-solid-char:
    @echo "üìö Ingesting solid.md with character-based chunking..."
    uv run lance-db-example ingest tests/data/solid.md --chunking-strategy character --chunk-size 1000
    @echo ""
    @echo "üîç Searching for 'throw redirect'..."
    uv run lance-db-example search "throw redirect" --limit 3
    @echo ""
    @echo "‚úÖ Demo complete!"
